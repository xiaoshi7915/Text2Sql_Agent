# 问数智能体系统架构设计文档

本文档详细描述了问数智能体系统的整体架构设计，包括系统结构、技术选型、模块组织以及部署方案等内容。

## 1. 系统概述

问数智能体是一个基于AI的智能数据分析平台，允许用户通过自然语言与数据库进行交互，实现复杂数据分析任务的自然语言处理和SQL生成。系统支持多种数据库类型连接，提供可视化查询结果展示，并支持对话历史管理等功能。

### 1.1 主要功能

- 自然语言到SQL转换
- 多种数据库连接支持
- 数据库元数据浏览与管理
- 对话式交互界面
- 查询结果可视化展示
- 历史对话记忆与管理
- 导出查询结果与对话记录

### 1.2 目标用户

- 数据分析师
- 业务人员
- 数据库管理员
- 非技术背景的决策者

## 2. 系统架构

问数智能体采用前后端分离的架构设计，包括前端应用、后端API服务、大模型服务和数据库四个主要部分。

### 2.1 整体架构图

```
┌───────────────────────────────────────────────────────────────────────┐
│                             客户端浏览器                                │
└───────────────────────────────┬───────────────────────────────────────┘
                                │
                                ▼
┌───────────────────────────────────────────────────────────────────────┐
│                             Nginx 网关                                 │
└───────────────────────────────┬───────────────────────────────────────┘
                                │
                ┌───────────────┴───────────────┐
                │                               │
                ▼                               ▼
┌────────────────────────────┐    ┌────────────────────────────────────┐
│                            │    │                                    │
│        前端 (Vue.js)        │    │          后端 API (Flask)          │
│                            │    │                                    │
└────────────────────────────┘    └──────────────────┬─────────────────┘
                                                    │
                                  ┌─────────────────┼─────────────────┐
                                  │                 │                 │
                                  ▼                 ▼                 ▼
                          ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
                          │               │ │               │ │               │
                          │ 用户数据库     │ │ 大模型服务     │ │ 外部数据源    │
                          │ (MySQL)       │ │ (LLM API)     │ │ (用户数据库)   │
                          │               │ │               │ │               │
                          └───────────────┘ └───────────────┘ └───────────────┘
```

### 2.2 核心组件

1. **前端应用**：
   - 基于Vue.js框架构建的单页面应用
   - 响应式设计，适配不同设备
   - 组件化开发，提高代码复用性

2. **后端API服务**：
   - 基于Flask框架开发的RESTful API
   - 处理前端请求，实现业务逻辑
   - 提供认证、授权和安全控制

3. **大模型服务**：
   - 对接大语言模型API
   - 处理自然语言到SQL的转换
   - 管理对话上下文和历史

4. **数据库层**：
   - 系统数据库：存储用户信息、对话历史、系统配置等
   - 外部数据源：用户连接的数据库，供查询分析

## 3. 前端架构

### 3.1 技术栈

- **框架**：Vue.js 3 + Vite
- **状态管理**：Pinia
- **UI组件库**：Element Plus
- **HTTP客户端**：Axios
- **数据可视化**：ECharts
- **代码高亮**：highlight.js
- **Markdown渲染**：markdown-it

### 3.2 目录结构

```
frontend/
├── public/               # 静态资源
├── src/
│   ├── assets/           # 图片、样式等资源
│   │   ├── common/       # 基础组件
│   │   ├── layout/       # 布局组件
│   │   └── chat/         # 对话相关组件
│   ├── views/            # 页面视图
│   ├── router/           # 路由配置
│   ├── store/            # 状态管理
│   ├── api/              # API调用封装
│   ├── utils/            # 工具函数
│   ├── plugins/          # 插件配置
│   ├── directives/       # 自定义指令
│   ├── constants/        # 常量定义
│   ├── hooks/            # 自定义钩子
│   ├── types/            # TypeScript类型定义
│   ├── App.vue           # 根组件
│   └── main.js           # 入口文件
├── tests/                # 测试文件
├── .env                  # 环境变量
├── .env.development      # 开发环境变量
├── .env.production       # 生产环境变量
├── vite.config.js        # Vite配置
└── package.json          # 依赖管理
```

### 3.3 核心模块

1. **认证模块**：
   - 登录/注册界面
   - 令牌管理
   - 权限控制

2. **数据源管理模块**：
   - 数据源添加、编辑、删除
   - 数据源连接测试
   - 数据库结构浏览

3. **对话交互模块**：
   - 对话输入框
   - 消息历史展示
   - 上下文管理

4. **数据展示模块**：
   - SQL查询结果表格
   - 数据可视化图表
   - 导出功能

5. **设置模块**：
   - 用户偏好设置
   - 主题切换
   - 语言设置

## 4. 后端架构

### 4.1 技术栈

- **框架**：Flask + Flask-RESTful
- **ORM**：SQLAlchemy
- **认证**：JWT (Flask-JWT-Extended)
- **数据库驱动**：PyMySQL, psycopg2, cx_Oracle等
- **API文档**：Swagger UI (Flask-RESTX)
- **并发处理**：Celery + Redis
- **缓存**：Redis

### 4.2 目录结构

```
backend/
├── app/
│   ├── __init__.py       # 应用初始化
│   ├── api/              # API路由和控制器
│   │   ├── auth/         # 认证相关API
│   │   ├── datasources/  # 数据源相关API
│   │   ├── conversations/# 对话相关API
│   │   └── users/        # 用户相关API
│   ├── models/           # 数据模型
│   ├── schemas/          # 数据验证和序列化
│   ├── services/         # 业务逻辑服务
│   │   ├── auth/         # 认证服务
│   │   ├── llm/          # 大模型服务
│   │   ├── datasource/   # 数据源服务
│   │   └── sql/          # SQL处理服务
│   ├── tasks/            # 异步任务
│   ├── utils/            # 工具函数
│   └── config.py         # 配置文件
├── migrations/           # 数据库迁移文件
├── tests/                # 测试文件
├── .env                  # 环境变量
├── celeryconfig.py       # Celery配置
├── wsgi.py               # WSGI入口
└── requirements.txt      # 依赖管理
```

### 4.3 核心模块

1. **认证模块**：
   - 用户注册与登录
   - JWT令牌生成与验证
   - 权限控制

2. **数据源管理模块**：
   - 数据源CRUD
   - 连接池管理
   - 元数据获取与缓存

3. **对话管理模块**：
   - 对话创建与记录
   - 消息存储与检索
   - 上下文维护

4. **NL2SQL模块**：
   - 自然语言处理
   - 上下文分析
   - SQL生成与优化
   - 验证与安全检查

5. **数据查询模块**：
   - SQL执行
   - 结果格式化
   - 数据导出

6. **任务管理模块**：
   - 异步任务调度
   - 长时间运行的查询
   - 定时任务

## 5. 数据库设计

系统使用MySQL作为主数据库，存储系统数据。详细的数据库设计见《数据库设计文档》。

### 5.1 主要数据表

- users：用户信息
- datasources：数据源配置
- conversations：对话会话
- messages：对话消息
- query_results：查询结果
- table_metadata_cache：表元数据缓存

## 6. 大模型集成

### 6.1 架构设计

```
┌────────────────────┐
│                    │
│   后端API服务       │
│                    │
└──────────┬─────────┘
           │
           ▼
┌──────────────────────────────────────┐
│           LLM适配器层                 │
├──────────────────────────────────────┤
│                                      │
│  ┌─────────────┐    ┌─────────────┐  │
│  │             │    │             │  │
│  │  提示词模板  │    │  结果解析器  │  │
│  │             │    │             │  │
│  └─────────────┘    └─────────────┘  │
│                                      │
└──────────────────┬───────────────────┘
                   │
                   ▼
┌──────────────────────────────────────┐
│           LLM提供商API               │
├──────────┬───────────────┬───────────┤
│          │               │           │
│   OpenAI │    Azure     │  其他LLM   │
│          │               │           │
└──────────┴───────────────┴───────────┘
```

### 6.2 关键组件

1. **LLM适配器**：
   - 统一API接口
   - 提供商无关的调用方式
   - 负载均衡和失败重试

2. **提示词工程**：
   - 基于情境的动态提示词模板
   - 上下文注入
   - 示例优化

3. **结果解析**：
   - SQL结果提取
   - 安全性检查
   - 格式规范化

4. **性能优化**：
   - 并发请求管理
   - 缓存常见问答
   - 流式响应处理

## 7. 数据流

### 7.1 用户查询流程

```
┌──────┐     ┌──────────┐     ┌──────────┐     ┌─────────┐     ┌───────────┐
│      │     │          │     │          │     │         │     │           │
│ 用户 │────►│ 前端应用 │────►│ 后端API  │────►│ 大模型  │────►│ 数据库查询 │
│      │     │          │     │          │     │         │     │           │
└──────┘     └──────────┘     └──────────┘     └─────────┘     └───────────┘
    ▲                              │                                  │
    │                              │                                  │
    └──────────────────────────────┴──────────────────────────────────┘
                               结果返回
```

1. 用户在前端输入自然语言查询
2. 前端发送查询到后端API
3. 后端准备上下文（包括数据库元数据、对话历史）
4. 将查询和上下文发送给大模型服务
5. 大模型生成SQL查询
6. 后端验证SQL安全性
7. 在用户数据库执行SQL查询
8. 格式化查询结果
9. 返回结果给前端
10. 前端展示结果给用户

### 7.2 数据源连接流程

```
┌──────┐     ┌──────────┐     ┌──────────┐     ┌─────────────┐
│      │     │          │     │          │     │             │
│ 用户 │────►│ 前端应用 │────►│ 后端API  │────►│ 外部数据源  │
│      │     │          │     │          │     │             │
└──────┘     └──────────┘     └──────────┘     └─────────────┘
                                   │                  │
                                   ▼                  │
                            ┌──────────────┐          │
                            │              │          │
                            │ 元数据缓存   │◄─────────┘
                            │              │
                            └──────────────┘
```

1. 用户配置数据源连接信息
2. 前端发送到后端API
3. 后端验证连接信息
4. 创建数据库连接
5. 获取并缓存数据库元数据
6. 返回连接状态和基本信息给前端

## 8. 安全设计

### 8.1 认证与授权

- JWT基础的身份验证
- 基于角色的访问控制(RBAC)
- API请求签名验证
- 令牌自动刷新机制

### 8.2 数据安全

- 加密存储敏感信息（如数据库密码）
- SQL注入防护
- 数据传输加密(HTTPS)
- 查询结果访问控制

### 8.3 API安全

- 请求频率限制
- 输入验证和净化
- 审计日志记录
- CORS策略控制

## 9. 部署架构

### 9.1 开发环境

- 本地Docker容器部署
- 开发数据库独立实例
- 模拟大模型服务

### 9.2 生产环境

```
┌─────────────────────────────────────────────────────────────────┐
│                        负载均衡器 (如ELB、Nginx)                   │
└───────────────────────────────┬─────────────────────────────────┘
                                │
            ┌─────────────────────────────────────┐
            │                                     │
  ┌─────────▼─────────┐               ┌───────────▼─────────┐
  │                   │               │                     │
  │   前端服务器集群    │               │    后端API服务器集群  │
  │  (Nginx + 静态文件) │               │    (Flask + uWSGI)   │
  │                   │               │                     │
  └───────────────────┘               └─────────────────────┘
                                                │
                          ┌────────────────────┬┴───────────────────┐
                          │                    │                    │
                ┌─────────▼─────────┐ ┌────────▼────────┐ ┌─────────▼─────────┐
                │                   │ │                 │ │                   │
                │     主数据库       │ │    缓存服务器    │ │    任务队列服务器   │
                │     (MySQL)       │ │    (Redis)      │ │  (Celery + Redis) │
                │                   │ │                 │ │                   │
                └───────────────────┘ └─────────────────┘ └───────────────────┘
                          │
                ┌─────────▼─────────┐
                │                   │
                │    数据库备份       │
                │                   │
                └───────────────────┘
```

### 9.3 可伸缩性设计

- 水平扩展API服务器
- 缓存层优化
- 数据库读写分离
- 微服务拆分可能性

### 9.4 监控与日志

- Prometheus + Grafana监控
- ELK/EFK日志收集与分析
- 用户行为跟踪
- 系统性能指标监控

## 10. 性能优化

### 10.1 前端性能

- 按需加载组件
- 静态资源优化
- 缓存策略
- 预渲染与懒加载

### 10.2 后端性能

- 数据库索引优化
- 查询结果缓存
- 连接池管理
- 异步任务处理

### 10.3 大模型调用优化

- 请求批处理
- 提示词优化
- 结果缓存
- 并发控制

## 11. 扩展性设计

### 11.1 支持新数据库类型

- 抽象数据库接口
- 驱动适配器模式
- 动态元数据提取

### 11.2 大模型切换

- 抽象LLM接口
- 多提供商支持
- 动态提示词模板

### 11.3 功能扩展点

- 插件系统设计
- 自定义SQL模板
- 用户自定义可视化
- API集成接口

## 12. 开发与运维规范

### 12.1 代码规范

- Python: PEP 8
- JavaScript: ESLint + Prettier
- 代码审查流程
- 单元测试覆盖率要求

### 12.2 CI/CD

- 自动化测试
- 持续集成流程
- 自动部署策略
- 环境隔离

### 12.3 版本管理

- 语义化版本
- 变更日志维护
- 特性分支工作流
- 发布计划

## 13. 风险与缓解策略

### 13.1 主要风险

1. **大模型服务中断**：
   - 缓解：本地缓存常见查询，降级机制
   
2. **数据安全风险**：
   - 缓解：严格的SQL验证，访问控制，敏感数据过滤

3. **性能瓶颈**：
   - 缓解：负载测试，性能监控，扩展设计

4. **用户体验不佳**：
   - 缓解：用户反馈机制，A/B测试，逐步改进

### 13.2 应急预案

- 服务降级策略
- 备份与恢复方案
- 安全事件响应流程
- 扩容预案

## 14. 未来规划

### 14.1 短期规划

- 支持更多数据库类型
- 增强SQL生成准确性
- 改进可视化能力
- 完善用户权限管理

### 14.2 长期规划

- 多语言支持
- 数据分析模板库
- 高级数据可视化
- 跨数据源分析能力
- 数据质量评估功能

## 15. 参考资料

1. Flask官方文档: https://flask.palletsprojects.com/
2. Vue.js官方文档: https://vuejs.org/guide/introduction.html
3. SQL注入防护最佳实践: https://owasp.org/www-community/attacks/SQL_Injection
4. JWT认证实践: https://jwt.io/introduction
5. 大型Web应用架构模式 